{% extends "_layout.html" %}
{% block title %}Jobs{% endblock %}
{% block content %}
<h1 class="mb-3">Jobs</h1>

<div class="row g-3 mb-3">
  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-body d-flex align-items-center justify-content-between">
        <div>
          <div class="text-muted small">Total Jobs</div>
          <div class="h4 mb-0">{{ jobs|length }}</div>
        </div>
        <i class="bi bi-list-task fs-3 text-primary"></i>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    {% set running_count = 0 %}
    {% set pending_count = 0 %}
    {% for j in jobs %}
      {% if (j.status or '')|lower == 'running' %}{% set running_count = running_count + 1 %}{% endif %}
      {% if (j.status or '')|lower == 'pending' %}{% set pending_count = pending_count + 1 %}{% endif %}
    {% endfor %}
    {% set active_total = running_count + pending_count %}
    <div class="card shadow-sm">
      <div class="card-body d-flex align-items-center justify-content-between">
        <div>
          <div class="text-muted small text-uppercase fw-bold">Active Jobs</div>
          <div class="h4 mb-0 text-primary">{{ active_total }}</div>
          <div class="small text-muted">
            <span class="text-primary">{{ running_count }} running</span>,
            <span class="text-warning">{{ pending_count }} pending</span>
          </div>
        </div>
        <i class="bi bi-activity fs-3 text-primary"></i>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="text-muted small">Disk Usage</div>
          {% if disk_usage %}
            <div class="fw-semibold">{{ disk_usage.used_gb }} / {{ disk_usage.total_gb }} GB (free {{ disk_usage.free_gb }} GB)</div>
          {% else %}
            <div class="fw-semibold">N/A</div>
          {% endif %}
        </div>
        {% if disk_usage %}
        {% set pct = (disk_usage.used_gb / disk_usage.total_gb * 100) if disk_usage.total_gb else 0 %}
        <div class="progress" style="height:10px;">
          <div class="progress-bar" role="progressbar" style="width: {{ pct }}%; background: linear-gradient(90deg, #1f6feb, #52b788);"></div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <form method="post" action="/jobs/batch">
      <div class="d-flex gap-2 mb-3">
        <button type="submit" class="btn btn-outline-secondary btn-sm" name="action" value="prune"><i class="bi bi-eraser"></i> Prune Selected</button>
        <button type="submit" class="btn btn-outline-danger btn-sm" name="action" value="delete"><i class="bi bi-trash"></i> Delete Selected</button>
      </div>
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th style="width:32px;"><input type="checkbox" onclick="const c=this.checked; document.querySelectorAll('input[name=job_ids]').forEach(cb=>cb.checked=c)"></th>
              <th>ID</th>
              <th>Recipe</th>
              <th>Status</th>
              <th>Created By</th>
              <th>Note</th>
              <th>Created</th>
              <th>Duration</th>
              <th>Size</th>
              <th>Exit Code</th>
              <th style="width:190px;">Actions</th>
            </tr>
          </thead>
          <tbody id="jobs-table-body" hx-get="/jobs" hx-trigger="every 5s" hx-select="#jobs-table-body" hx-swap="outerHTML">
            {% for j in jobs %}
            {% set states = job_states or {} %}
            {% set state = states.get(j.id, {}) %}
            {% set is_pruned = state.is_pruned %}
            {% set st = (j.status or '')|lower %}
            {% set is_pinned = j.pinned %}
            {% set badge_class = 'bg-secondary' %}
            {% if st == 'success' %}{% set badge_class = 'bg-success' %}{% elif st == 'failed' %}{% set badge_class = 'bg-danger' %}{% elif st == 'running' %}{% set badge_class = 'bg-primary progress-bar-striped progress-bar-animated' %}{% elif st == 'pending' %}{% set badge_class = 'bg-warning text-dark' %}{% endif %}
            <tr class="{% if is_pinned %}border-start border-4 border-warning bg-warning bg-opacity-10{% endif %}">
              <td><input type="checkbox" name="job_ids" value="{{ j.id }}" {% if is_pinned %}disabled{% endif %}></td>
              <td>
                <a href="/jobs/{{ j.id }}" class="fw-semibold text-primary text-decoration-underline">{{ j.id }}</a>
                <form method="post" action="/jobs/{{ j.id }}/pin" class="d-inline">
                  <button type="submit" name="pinned" value="{% if is_pinned %}0{% else %}1{% endif %}" class="btn btn-sm btn-outline-warning" title="Toggle pin">
                    <i class="bi {% if is_pinned %}bi-pin-fill{% else %}bi-pin-angle{% endif %}"></i>
                  </button>
                </form>
              </td>
              <td>
                {% if j.recipe_id %}
                  <a href="/jobs/{{ j.id }}" class="text-primary text-decoration-underline">{{ j.recipe_id }}</a>
                {% else %}
                  -
                {% endif %}
              </td>
              <td><span class="badge {{ badge_class }} text-uppercase">{{ j.status }}</span></td>
              <td>{{ j.created_by or j.owner }}</td>
              <td>{% if j.note %}{{ j.note }}{% else %}-{% endif %}</td>
              <td>{{ j.created_at or '-' }}</td>
              <td>{{ j.duration or '-' }}</td>
              <td>{% if is_pruned %}Pruned{% elif state.disk_usage_clean or state.disk_usage %}{{ state.disk_usage_clean or state.disk_usage }}{% else %}-{% endif %}</td>
              <td>{% if j.exit_code is not none %}{{ j.exit_code }}{% else %}-{% endif %}</td>
              <td class="d-flex gap-1">
                <a href="/jobs/{{ j.id }}" class="btn btn-sm btn-outline-primary" title="View details"><i class="bi bi-eye"></i></a>
                <button type="button" class="btn btn-sm btn-outline-secondary" title="Copy workspace path" data-copy-path="{{ state.workspace_path or '' }}"><i class="bi bi-clipboard"></i></button>
                {% if st in ['success', 'failed'] and not is_pruned and not is_pinned %}
                <button type="submit" formaction="/jobs/{{ j.id }}/prune" formmethod="post" class="btn btn-sm btn-outline-secondary" title="Prune workspace"><i class="bi bi-eraser"></i></button>
                {% else %}
                <button type="button" class="btn btn-sm btn-outline-secondary disabled" title="Prune unavailable"><i class="bi bi-eraser"></i></button>
                {% endif %}
                <button type="submit" formaction="/jobs/{{ j.id }}/delete" formmethod="post" class="btn btn-sm btn-outline-danger" title="Delete job" {% if is_pinned %}disabled{% endif %}><i class="bi bi-trash"></i></button>
              </td>
            </tr>
            {% else %}
            <tr><td colspan="11" class="text-center text-muted py-4">No jobs yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </form>
  </div>
</div>

<script>
  (() => {
    function showCopyNotice(message) {
      const toast = document.createElement("div");
      toast.textContent = message;
      Object.assign(toast.style, {
        position: "fixed",
        top: "12px",
        left: "50%",
        transform: "translateX(-50%)",
        padding: "6px 12px",
        background: "#0d6efd",
        color: "#fff",
        borderRadius: "6px",
        boxShadow: "0 0.35rem 1rem rgba(0,0,0,0.15)",
        zIndex: 1080,
        opacity: "0",
        transition: "opacity 150ms ease-in-out"
      });
      document.body.appendChild(toast);
      requestAnimationFrame(() => (toast.style.opacity = "1"));
      setTimeout(() => {
        toast.style.opacity = "0";
        setTimeout(() => toast.remove(), 200);
      }, 1400);
    }

    document.addEventListener("click", async (event) => {
      const btn = event.target.closest("[data-copy-path]");
      if (!btn) return;
      const path = btn.getAttribute("data-copy-path");
      if (!path) return;
      try {
        await navigator.clipboard.writeText(path);
        showCopyNotice("Path copied!");
      } catch (err) {
        console.warn("Failed to copy path", err);
        alert("Could not copy path");
      }
    });
  })();
</script>
{% endblock %}
