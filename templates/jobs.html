{% extends "_layout.html" %}
{% block title %}Jobs{% endblock %}
{% block content %}
<h1>Jobs</h1>
{% if disk_usage %}
<div class="card" style="margin-bottom: 1rem;">
    {% set du = disk_usage %}
    {% set pct = 0 %}
    {% if du.total_gb and du.total_gb > 0 %}
        {% set pct = (du.used_gb / du.total_gb) * 100 %}
    {% endif %}
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
        <div><strong>Disk Usage</strong></div>
        <div>{{ du.used_gb }} GB used / {{ du.total_gb }} GB total (free {{ du.free_gb }} GB)</div>
    </div>
    <div style="height: 12px; background: #eef1f5; border-radius: 6px; overflow: hidden;">
        <div style="height: 12px; width: {{ '%.0f' % pct }}%; background: linear-gradient(90deg, #1f6feb, #52b788);"></div>
    </div>
</div>
{% endif %}
<div class="card">
    <form method="post" action="/jobs/batch">
    <div style="display:flex; gap:0.5rem; margin-bottom:0.5rem;">
        <button type="submit" name="action" value="prune">Prune Selected</button>
        <button type="submit" name="action" value="delete">Delete Selected</button>
    </div>
    <table>
        <thead>
            <tr>
                <th><input type="checkbox" onclick="const c=this.checked; document.querySelectorAll('input[name=job_ids]').forEach(cb=>cb.checked=c)"></th>
                <th>ID</th>
                <th>Recipe</th>
                <th>Status</th>
                <th>Created By</th>
                <th>Note</th>
                <th>Created</th>
                <th>Size</th>
                <th>Exit Code</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for j in jobs %}
            {% set states = job_states or {} %}
            {% set state = states.get(j.id, {}) %}
            {% set is_pruned = state.is_pruned %}
            {% set st = (j.status or '')|lower %}
            {% set is_pinned = j.pinned %}
            <tr {% if is_pinned %}style="background:#fff9e6;border-left:4px solid #f4c842;"{% endif %}>
                <td><input type="checkbox" name="job_ids" value="{{ j.id }}" {% if is_pinned %}disabled{% endif %}></td>
                <td>
                    <a href="/jobs/{{ j.id }}">{{ j.id }}</a>
                    <form method="post" action="/jobs/{{ j.id }}/pin" style="display:inline;">
                        <button type="submit" name="pinned" value="{% if is_pinned %}0{% else %}1{% endif %}" title="Toggle pin" style="border:none;background:none;cursor:pointer;">
                            <span class="bi {% if is_pinned %}bi-pin-fill{% else %}bi-pin-angle{% endif %}" {% if is_pinned %}style="color:#d97706;"{% endif %}></span>
                        </button>
                    </form>
                </td>
                <td>{{ j.recipe_id or '-' }}</td>
                <td>{{ j.status }}</td>
                <td>{{ j.created_by or j.owner }}</td>
                <td>{% if j.note %}{{ j.note }}{% else %}-{% endif %}</td>
                <td>{{ j.created_at or '-' }}</td>
                <td>
                    {% if is_pruned %}Pruned{% elif state.disk_usage %}{{ state.disk_usage }}{% else %}-{% endif %}
                </td>
                <td>{% if j.exit_code is not none %}{{ j.exit_code }}{% else %}-{% endif %}</td>
                <td>
                    {% if st in ['success', 'failed'] and not is_pruned and not is_pinned %}
                        <button type="submit" formaction="/jobs/{{ j.id }}/prune" formmethod="post">Prune</button>
                    {% else %}-{% endif %}
                    <button type="submit" formaction="/jobs/{{ j.id }}/delete" formmethod="post" style="margin-left:0.25rem;" {% if is_pinned %}disabled{% endif %}>Delete</button>
                </td>
            </tr>
            {% else %}
            <tr><td colspan="10">No jobs yet.</td></tr>
            {% endfor %}
        </tbody>
    </table>
    </form>
</div>
{% endblock %}
