{% extends "_layout.html" %}
{% block title %}Job {{ job.id }}{% endblock %}
{% block content %}
    <h1 style="display:flex;align-items:center;gap:0.5rem;">
        <span>Job {{ job.id }}</span>
        <form method="post" action="/jobs/{{ job.id }}/pin">
            <button type="submit" name="pinned" value="{% if job.pinned %}0{% else %}1{% endif %}" title="Toggle pin" style="border:none;background:none;cursor:pointer;">
                <span class="bi {% if job.pinned %}bi-pin-fill{% else %}bi-pin-angle{% endif %}" {% if job.pinned %}style="color:#d97706;"{% endif %}></span>
            </button>
        </form>
    </h1>
    <p><a href="/new">New job</a></p>
    <div id="job" data-job-id="{{ job.id }}">
        <p>Status: <span id="job-status">{{ job.status }}</span></p>
        <p>Recipe: <code>{{ job.recipe_id or 'unknown' }}</code></p>
        <p>Created by: {{ job.created_by or job.owner }}</p>
        <p>Note: {% if job.note %}{{ job.note }}{% else %}-{% endif %}</p>
        <p>Created: {{ job.created_at }}{% if job.started_at %}, Started: {{ job.started_at }}{% endif %}{% if job.finished_at %}, Finished: {{ job.finished_at }}{% endif %}</p>
    </div>

    <h2>Recipe Snapshot</h2>
    <div class="card" style="max-width: 820px;">
        {% if job.raw_recipe_yaml %}
            <details open>
                <summary>raw_recipe_yaml</summary>
                <pre style="white-space:pre-wrap">{{ job.raw_recipe_yaml }}</pre>
            </details>
        {% else %}
            <p>No recipe captured for this job.</p>
        {% endif %}
    </div>

    <h2 style="display:flex;justify-content:space-between;align-items:center;">
        <span>Logs</span>
        <a href="/jobs/{{ job.id }}/log/download" class="button">Download Full Log</a>
    </h2>
    <div id="terminal-console" style="background:#0b0b0b;color:#e5e5e5;padding:1rem;border-radius:8px;border:1px solid #222;max-height:80vh;overflow-y:scroll;white-space:pre-wrap;font-family:Consolas, 'Courier New', monospace;">
        <div id="log-loading">Loading...</div>
    </div>

    <h2>Artifacts</h2>
    <ul id="artifact-list">
        {% for item in artifacts.values() %}
            <li><a href="/api/jobs/{{ job.id }}/artifacts/{{ item.name }}">{{ item.name }}</a> ({{ item.size }} bytes)</li>
        {% else %}
            <li>No artifacts yet.</li>
        {% endfor %}
    </ul>

<script>
    (function() {
        const jobId = {{ job.id }};
        const jobStatus = "{{ job.status or '' }}".toLowerCase();
        const consoleEl = document.getElementById("terminal-console");
        const loadingEl = document.getElementById("log-loading");
        let currentOffset = 0;
        let stopped = false;

        // Simple ANSI-to-HTML handling (basic colors and reset)
        function parseAnsi(text) {
            return text
                .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") // HTML Escape
                .replace(/\x1b\[0m/g, '</span>')                                    // Reset
                .replace(/\x1b\[31m/g, '<span style="color:#ff5555">')              // Red
                .replace(/\x1b\[32m/g, '<span style="color:#50fa7b">')              // Green
                .replace(/\x1b\[33m/g, '<span style="color:#f1fa8c">')              // Yellow
                .replace(/\x1b\[34m/g, '<span style="color:#bd93f9">')              // Blue
                .replace(/\x1b\[36m/g, '<span style="color:#8be9fd">')              // Cyan
                .replace(/\x1b\[1m/g, '<span style="font-weight:bold">')            // Bold
                .replace(/\x1b\[\d+;?\d*m/g, '');                                   // Ignore other complex codes
        }

        function appendLog(text) {
            if (loadingEl) loadingEl.remove();
            
            // Detect whether we are at the bottom (auto-scroll check)
            const atBottom = consoleEl.scrollTop + consoleEl.clientHeight >= consoleEl.scrollHeight - 50;
            
            // 1. Parse ANSI and insert via innerHTML
            const htmlContent = parseAnsi(text);
            consoleEl.insertAdjacentHTML('beforeend', htmlContent);

            // 2. Buffer limiting: if content grows too large, drop from the start to save memory
            if (consoleEl.childNodes.length > 5000) { // Simple heuristic by node count
                 while (consoleEl.childNodes.length > 2000) {
                    consoleEl.removeChild(consoleEl.firstChild);
                 }
            }

            // 3. Auto-scroll
            if (atBottom) {
                consoleEl.scrollTop = consoleEl.scrollHeight;
            }
        }

        async function fetchLogChunk() {
            if (stopped) return;
            try {
                const resp = await fetch(`/jobs/${jobId}/log/stream?offset=${currentOffset}`);
                if (!resp.ok) throw new Error("fetch failed");
                const data = await resp.json();
                
                if (data.content) {
                    appendLog(data.content);
                }
                
                currentOffset = data.next_offset || currentOffset;
                const eof = !!data.eof;
                const running = jobStatus === "running";
                
                // If the job is still running, keep polling even if temporarily at EOF; slow down once finished
                const delay = (eof && !running) ? 10000 : 2000;
                
                setTimeout(fetchLogChunk, delay);
            } catch (err) {
                console.warn("Log stream error:", err);
                setTimeout(fetchLogChunk, 5000);
            }
        }

        fetchLogChunk();
    })();
    </script>
{% endblock %}
