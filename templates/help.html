{% extends "_layout.html" %}
{% block title %}Help{% endblock %}
{% block content %}
<div class="card shadow-sm">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2 id="title-en" class="mb-0">BuildServer User Manual</h2>
        <h2 id="title-zh" class="mb-0" style="display: none;">BuildServer ä½¿ç”¨æ‰‹å†Š</h2>
      </div>
      <div class="btn-group" role="group" aria-label="Language toggle">
        <button type="button" class="btn btn-outline-primary btn-sm active" data-lang="en">English</button>
        <button type="button" class="btn btn-outline-primary btn-sm" data-lang="zh">ä¸­æ–‡</button>
      </div>
    </div>

    <div id="lang-en">
      <h3 class="mt-3">1. Quick Start</h3>
      <ol>
        <li><strong>Login</strong>: Sign in with your system credentials.</li>
        <li><strong>Setup Profile</strong>: Go to Profile, enter your GitLab Token and Email.</li>
        <li><strong>Create Job</strong>: Click <em>New Job</em>, select a Recipe, and hit Create.</li>
        <li><strong>Wait</strong>: You will receive an email notification when done.</li>
      </ol>

      <h3 class="mt-4">2. Initial Setup</h3>
      <ul>
        <li><strong>Profile</strong>: You must set your <strong>GitLab Username &amp; Token</strong> (for accessing code) and <strong>Notification Email</strong> (for alerts). Donâ€™t forget to click â€œSave Profileâ€.</li>
      </ul>

      <h3 class="mt-4">3. Core Concepts</h3>
      <ul>
        <li><strong>Recipes</strong>: YAML templates (in <code>platform/project.yaml</code>) defining how to build a project.</li>
        <li><strong>Jobs</strong>: A specific execution of a recipe. Each job has a unique ID and workspace.</li>
      </ul>

      <h3 class="mt-4">4. Job Management</h3>
      <ul>
        <li><strong>Status</strong>: ğŸ”¸ Pending, ğŸ”¹ Running, âœ… Success, ğŸ”´ Failed.</li>
        <li><strong>Actions</strong>:
          <ul>
            <li><strong>Pin</strong>: Protect a job from auto-cleanup.</li>
            <li><strong>Retry</strong>: Rerun a finished job in-place.</li>
            <li><strong>Prune</strong>: Remove workspace files to save disk space (logs are kept).</li>
            <li><strong>SSH Connect</strong>: Click the <strong>Terminal Icon</strong> to copy the SSH command for direct debugging.</li>
          </ul>
        </li>
      </ul>

      <h3 class="mt-4">5. Advanced Debugging (SSH)</h3>
      <p>Click â€œCopy SSHâ€ to get a command like:</p>
      <blockquote><code>ssh -tt user@host "cd /work/jobs/123 &amp;&amp; exec bash -l"</code></blockquote>
      <p>This logs you directly into the jobâ€™s workspace with the environment loaded.</p>

      <h3 class="mt-4">6. Recipe Configuration Guide</h3>
      <p>Recipes are defined in YAML format. The system executes blocks in this order: <strong>Clone &rarr; Init &rarr; Edit/Patch &rarr; Build</strong>. Patch runs after Init so you can modify generated files (e.g., <code>build/conf/local.conf</code>).</p>

      <h5 class="mt-3">Working Directory by Stage</h5>
      <ul>
        <li><strong>Clone</strong>: Runs in the workspace root. Create/clone your project folder here.</li>
        <li><strong>Init</strong>: Runs in the project root (or workspace root if no <code>workdir</code>). Sets up env and build directories.</li>
        <li><strong>Edit/Patch</strong>: Runs after Init in the project root (source tree). Patch paths are relative to this root (e.g., <code>build/conf/local.conf</code>).</li>
        <li><strong>Build</strong>: Runs inside the build directory saved from Init (context restored automatically).</li>
      </ul>

      <div class="card bg-light border-0">
        <div class="card-header bg-transparent border-0 pb-0">
            <span class="badge bg-primary">Real-World Example: AST2600 EVB</span>
        </div>
        <div class="card-body p-3">
<pre><code class="language-yaml">schema_version: 1
display_name: "AST2600 EVB Mainline"
workdir: "onetree"  # Project root; Init/Build/Patch run here

# 1. Clone Stage (workspace root)
clone_block:
  lines:
    - git clone https://git.ami.com/core/ami-bmc/base-tech/openbmc onetree
    - cd onetree && git clone https://git.ami.com/core/ami-bmc/one-tree/core/meta-core
    - cd onetree && git clone https://git.ami.com/core/ami-bmc/one-tree/core/meta-ami
    - cd onetree && git clone https://git.ami.com/core/ami-bmc/one-tree/amd/crb/venice meta-amd/meta-venice

# 2. Init Stage (project root)
init_block:
  lines:
    - meta-ami/github-gitlab-url.sh
    - TEMPLATECONF=meta-ami/meta-evb/meta-evb-aspeed/meta-evb-ast2600/conf/templates/default . openbmc-env

# 3. Edit/Patch Stage (project root) - runs after Init
patch_block:
  - path: "build/conf/local.conf"   # Relative to project root
    action: append
    content: 'IMAGE_INSTALL:append = " my-package"'
  - path: "meta-ami/conf/layer.conf"
    action: replace
    find: 'CORE_IMAGE_EXTRA_INSTALL ?= ""'
    content: 'CORE_IMAGE_EXTRA_INSTALL ?= "ami-base"'

# 4. Build Stage (build dir preserved from Init)
build_block:
  lines:
    - bitbake obmc-phosphor-image</code></pre>
        </div>
      </div>

      <h5 class="mt-3">Block Definition &amp; Working Directory</h5>
      <ul>
          <li><code>clone_block</code>: Runs in the workspace root. Clone source code here.</li>
          <li><code>init_block</code>: Runs in the project root (or workspace root if no <code>workdir</code>). Use for environment setup.</li>
          <li><code>patch_block</code>: Runs after Init in the project root. Paths are relative to the source root (e.g., <code>build/conf/local.conf</code>).</li>
          <li><code>build_block</code>: Runs inside the build directory saved from Init (context is restored automatically).</li>
      </ul>
    </div>

    <div id="lang-zh" style="display: none;">
      <h3 class="mt-4">1. å¿«é€Ÿé–‹å§‹ (Quick Start)</h3>
      <ol>
          <li><strong>ç™»å…¥</strong>ï¼šä½¿ç”¨ç³»çµ±å¸³å¯†ç™»å…¥ã€‚</li>
          <li><strong>è¨­å®š Profile</strong>ï¼šåˆ° My Profile å¡«å¯« GitLab Token èˆ‡ Emailã€‚</li>
          <li><strong>å»ºç«‹ Job</strong>ï¼šé»é¸ Create Jobï¼Œé¸æ“‡ Recipe å¾ŒæŒ‰ Createã€‚</li>
          <li><strong>ç­‰å¾…é€šçŸ¥</strong>ï¼šå®Œæˆå¾Œæœƒå¯„é€ Email é€šçŸ¥ã€‚</li>
      </ol>

      <h3 class="mt-4">2. åˆå§‹è¨­å®š (Initial Setup)</h3>
      <ul>
          <li><strong>Profile å¿…å¡«</strong>ï¼šéœ€å¡«å¯« <strong>GitLab Username &amp; Token</strong>ï¼ˆå–å¾—ç¨‹å¼ç¢¼ï¼‰èˆ‡ <strong>Notification Email</strong>ï¼ˆé€šçŸ¥ï¼‰ï¼Œä¸¦æŒ‰ä¸‹ â€œSave Profileâ€ã€‚</li>
      </ul>

      <h3 class="mt-4">3. æ ¸å¿ƒæ¦‚å¿µ (Core Concepts)</h3>
      <ul>
          <li><strong>Recipesï¼ˆé…æ–¹ï¼‰</strong>ï¼šå®šç¾©å»ºç½®æµç¨‹çš„ YAMLï¼ˆæ”¾åœ¨ <code>platform/project.yaml</code>ï¼‰ã€‚</li>
          <li><strong>Jobsï¼ˆä»»å‹™ï¼‰</strong>ï¼šä¸€æ¬¡ Recipe åŸ·è¡Œï¼Œæ¯å€‹ Job æœ‰ç¨ç«‹ ID èˆ‡ Workspaceã€‚</li>
      </ul>

      <h3 class="mt-4">4. ä»»å‹™ç®¡ç† (Job Management)</h3>
      <ul>
          <li><strong>ç‹€æ…‹</strong>ï¼šğŸ”¸ Pendingã€ğŸ”¹ Runningã€âœ… Successã€ğŸ”´ Failedã€‚</li>
          <li><strong>æ“ä½œ</strong>ï¼š
              <ul>
                  <li><strong>Pin</strong>ï¼šé˜²æ­¢ä»»å‹™è¢«è‡ªå‹•æ¸…ç†ã€‚</li>
                  <li><strong>Retry</strong>ï¼šé‡æ–°åŸ·è¡Œå·²å®Œæˆçš„ä»»å‹™ã€‚</li>
                  <li><strong>Prune</strong>ï¼šæ¸…ç† Workspace ç¯€çœç©ºé–“ï¼ˆä¿ç•™ Logï¼‰ã€‚</li>
                  <li><strong>SSH Connect</strong>ï¼šé»ã€Œçµ‚ç«¯æ©Ÿåœ–ç¤ºã€è¤‡è£½ SSH æŒ‡ä»¤ä»¥ä¾¿é™¤éŒ¯ã€‚</li>
              </ul>
          </li>
      </ul>

      <h3 class="mt-4">5. é€²éšé™¤éŒ¯ (SSH)</h3>
      <p>æŒ‰ä¸‹ â€œCopy SSHâ€ æœƒå¾—åˆ°ï¼š</p>
      <blockquote><code>ssh -tt user@host "cd /work/jobs/123 &amp;&amp; exec bash -l"</code></blockquote>
      <p>æœƒç›´æ¥é€²å…¥è©² Job çš„ Workspaceï¼Œç’°å¢ƒå·²è¼‰å…¥ã€‚</p>

      <h3 class="mt-4">6. Recipe é…ç½®æŒ‡å— (Recipe Configuration Guide)</h3>
      <p>Recipe ä»¥ YAML å®šç¾©ï¼ŒåŸ·è¡Œé †åºç‚º <strong>Clone &rarr; Init &rarr; Edit/Patch &rarr; Build</strong>ã€‚Patch æ’åœ¨ Init ä¹‹å¾Œï¼Œå¯ä¿®æ”¹ Init ç”¢ç”Ÿçš„æª”æ¡ˆï¼ˆä¾‹å¦‚ <code>build/conf/local.conf</code>ï¼‰ã€‚</p>

      <h5 class="mt-3">å„éšæ®µå·¥ä½œç›®éŒ„</h5>
      <ul>
          <li><strong>Clone</strong>ï¼šåœ¨ workspace root åŸ·è¡Œï¼Œç”¨ä¾†å»ºç«‹/clone å°ˆæ¡ˆç›®éŒ„ã€‚</li>
          <li><strong>Init</strong>ï¼šåœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„åŸ·è¡Œï¼ˆæœªè¨­å®š <code>workdir</code> å‰‡åœ¨ workspace rootï¼‰ï¼Œç”¨ä¾†è¨­å®šç’°å¢ƒèˆ‡å»ºç«‹ build ç›®éŒ„ã€‚</li>
          <li><strong>Edit/Patch</strong>ï¼šInit ä¹‹å¾Œåœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„åŸ·è¡Œï¼Œè·¯å¾‘ä»¥åŸå§‹ç¢¼æ ¹ç›®éŒ„ç‚ºåŸºæº–ï¼ˆä¾‹å¦‚ <code>build/conf/local.conf</code>ï¼‰ã€‚</li>
          <li><strong>Build</strong>ï¼šåœ¨ Init ä¿å­˜çš„ build ç›®éŒ„å…§åŸ·è¡Œï¼ˆè‡ªå‹•é‚„åŸ contextï¼‰ã€‚</li>
      </ul>

      <div class="card bg-light border-0">
        <div class="card-header bg-transparent border-0 pb-0">
            <span class="badge bg-primary">å¯¦ä¾‹ï¼šAST2600 EVB</span>
        </div>
        <div class="card-body p-3">
          <pre><code class="language-yaml">schema_version: 1
display_name: "AST2600 EVB Mainline"
workdir: "onetree"  # å°ˆæ¡ˆæ ¹ç›®éŒ„ï¼ŒInit/Build/Patch éƒ½åœ¨é€™è£¡

# 1. Clone éšæ®µ (workspace root)
clone_block:
  lines:
    - git clone https://git.ami.com/core/ami-bmc/base-tech/openbmc onetree
    - cd onetree && git clone https://git.ami.com/core/ami-bmc/one-tree/core/meta-core
    - cd onetree && git clone https://git.ami.com/core/ami-bmc/one-tree/core/meta-ami
    - cd onetree && git clone https://git.ami.com/core/ami-bmc/one-tree/amd/crb/venice meta-amd/meta-venice

# 2. Init éšæ®µ (å°ˆæ¡ˆæ ¹ç›®éŒ„)
init_block:
  lines:
    - meta-ami/github-gitlab-url.sh
    - TEMPLATECONF=meta-ami/meta-evb/meta-evb-aspeed/meta-evb-ast2600/conf/templates/default . openbmc-env

# 3. Edit/Patch éšæ®µ (å°ˆæ¡ˆæ ¹ç›®éŒ„ï¼ŒInit ä¹‹å¾Œ)
patch_block:
  - path: "build/conf/local.conf"   # ç›¸å°æ–¼å°ˆæ¡ˆæ ¹ç›®éŒ„
    action: append
    content: 'IMAGE_INSTALL:append = " my-package"'
  - path: "meta-ami/conf/layer.conf"
    action: replace
    find: 'CORE_IMAGE_EXTRA_INSTALL ?= ""'
    content: 'CORE_IMAGE_EXTRA_INSTALL ?= "ami-base"'

# 4. Build éšæ®µ (Init ä¿å­˜çš„ build ç›®éŒ„)
build_block:
  lines:
    - bitbake obmc-phosphor-image</code></pre>
        </div>
      </div>

      <h5 class="mt-3">å€å¡Šèªªæ˜èˆ‡å·¥ä½œç›®éŒ„</h5>
      <ul>
          <li><code>clone_block</code>ï¼šåœ¨ workspace root åŸ·è¡Œï¼Œç”¨ä¾†æŠ“å–åŸå§‹ç¢¼ã€‚</li>
          <li><code>init_block</code>ï¼šåœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„ï¼ˆæˆ–æœªè¨­ <code>workdir</code> æ™‚çš„ workspace rootï¼‰åŸ·è¡Œï¼Œè² è²¬ç’°å¢ƒè¨­å®šã€‚</li>
          <li><code>patch_block</code>ï¼šInit ä¹‹å¾Œåœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„åŸ·è¡Œï¼Œè·¯å¾‘ä»¥åŸå§‹ç¢¼æ ¹ç›®éŒ„ç‚ºåŸºæº–ï¼ˆå¦‚ <code>build/conf/local.conf</code>ï¼‰ã€‚</li>
          <li><code>build_block</code>ï¼šåœ¨ Init ä¿å­˜çš„ build ç›®éŒ„å…§åŸ·è¡Œï¼Œcontext æœƒè‡ªå‹•é‚„åŸã€‚</li>
      </ul>
    </div>
  </div>
</div>

<script>
  (() => {
    const buttons = document.querySelectorAll("[data-lang]");
    const en = document.getElementById("lang-en");
    const zh = document.getElementById("lang-zh");
    const titleEn = document.getElementById("title-en");
    const titleZh = document.getElementById("title-zh");
    function setLang(lang) {
      if (!en || !zh) return;
      if (lang === "zh") {
        en.style.display = "none";
        zh.style.display = "";
        if (titleEn && titleZh) {
          titleEn.style.display = "none";
          titleZh.style.display = "";
        }
      } else {
        en.style.display = "";
        zh.style.display = "none";
        if (titleEn && titleZh) {
          titleEn.style.display = "";
          titleZh.style.display = "none";
        }
      }
      buttons.forEach((btn) => {
        const isActive = btn.getAttribute("data-lang") === lang;
        btn.classList.toggle("active", isActive);
      });
    }
    buttons.forEach((btn) => {
      btn.addEventListener("click", () => setLang(btn.getAttribute("data-lang") || "en"));
    });
    setLang("en");
  })();
</script>
{% endblock %}
