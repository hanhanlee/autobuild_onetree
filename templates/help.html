{% extends "_layout.html" %}
{% block title %}Help{% endblock %}
{% block content %}
<div class="card shadow-sm">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">BuildServer User Manual</h2>
      <div class="btn-group" role="group" aria-label="Language toggle">
        <button type="button" class="btn btn-outline-primary btn-sm active" data-lang="en">English</button>
        <button type="button" class="btn btn-outline-primary btn-sm" data-lang="zh">ä¸­æ–‡</button>
      </div>
    </div>

    <div id="lang-en">
      <h3 class="mt-3">1. Quick Start</h3>
      <ol>
        <li><strong>Login</strong>: Sign in with your system credentials.</li>
        <li><strong>Setup Profile</strong>: Go to Profile, enter your GitLab Token and Email.</li>
        <li><strong>Create Job</strong>: Click <em>New Job</em>, select a Recipe, and hit Create.</li>
        <li><strong>Wait</strong>: You will receive an email notification when done.</li>
      </ol>

      <h3 class="mt-4">2. Initial Setup</h3>
      <ul>
        <li><strong>Profile</strong>: You must set your <strong>GitLab Username &amp; Token</strong> (for accessing code) and <strong>Notification Email</strong> (for alerts). Donâ€™t forget to click â€œSave Profileâ€.</li>
      </ul>

      <h3 class="mt-4">3. Core Concepts</h3>
      <ul>
        <li><strong>Recipes</strong>: YAML templates (in <code>platform/project.yaml</code>) defining how to build a project.</li>
        <li><strong>Jobs</strong>: A specific execution of a recipe. Each job has a unique ID and workspace.</li>
      </ul>

      <h3 class="mt-4">4. Job Management</h3>
      <ul>
        <li><strong>Status</strong>: ğŸŸ  Pending, ğŸ”µ Running, ğŸŸ¢ Success, ğŸ”´ Failed.</li>
        <li><strong>Actions</strong>:
          <ul>
            <li><strong>Pin</strong>: Protect a job from auto-cleanup.</li>
            <li><strong>Retry</strong>: Rerun a finished job in-place.</li>
            <li><strong>Prune</strong>: Remove workspace files to save disk space (logs are kept).</li>
            <li><strong>SSH Connect</strong>: Click the <strong>Terminal Icon</strong> to copy the SSH command for direct debugging.</li>
          </ul>
        </li>
      </ul>

      <h3 class="mt-4">5. Advanced Debugging (SSH)</h3>
      <p>Click â€œCopy SSHâ€ to get a command like:</p>
      <blockquote><code>ssh -tt user@host "cd /work/jobs/123 &amp;&amp; exec bash -l"</code></blockquote>
      <p>This logs you directly into the jobâ€™s workspace with the environment loaded.</p>

      <h3 class="mt-4">6. Recipe Configuration Guide</h3>
      <p>Recipes are defined in YAML format. The system executes blocks in this order: <strong>Clone &rarr; Patch &rarr; Init &rarr; Build</strong>.</p>

      <div class="card bg-light border-0">
        <div class="card-header bg-transparent border-0 pb-0">
            <span class="badge bg-primary">Real-World Example: AST2600 EVB</span>
        </div>
        <div class="card-body p-3">
<pre><code class="language-yaml">schema_version: 1
display_name: "AST2600 EVB Mainline"
# Note: 'workdir' is optional. If omitted, you must 'cd' into directories manually.

# 1. Clone Stage
clone_block:
  lines:
    # Clone base repo and enter it to clone sub-layers inside
    - git clone https://git.ami.com/core/ami-bmc/base-tech/openbmc onetree; cd onetree
    - git clone https://git.ami.com/core/ami-bmc/one-tree/core/meta-core
    - git clone https://git.ami.com/core/ami-bmc/one-tree/core/meta-ami
    # Add EVB specific layer
    - git clone https://git.ami.com/core/ami-bmc/one-tree/amd/crb/venice meta-amd/meta-venice

# 2. Patch Stage (Optional)
# Modifies files BEFORE the Init stage.
patch_block:
  # Example: Append a package to local.conf
  - path: "conf/local.conf"
    action: append
    content: 'IMAGE_INSTALL:append = " my-package"'
  # Example: Replace text in a layer config
  - path: "meta-ami/conf/layer.conf"
    action: replace
    find: 'CORE_IMAGE_EXTRA_INSTALL ?= ""'
    content: 'CORE_IMAGE_EXTRA_INSTALL ?= "ami-base"'

# 3. Init Stage
init_block:
  lines:
    # We must enter the directory because 'workdir' key was not set
    - cd onetree
    - meta-ami/github-gitlab-url.sh
    - TEMPLATECONF=meta-ami/meta-evb/meta-evb-aspeed/meta-evb-ast2600/conf/templates/default . openbmc-env

# 4. Build Stage
build_block:
  lines:
    - bitbake obmc-phosphor-image</code></pre>
        </div>
      </div>

      <h5 class="mt-3">Block Definition</h5>
      <ul>
          <li><code>clone_block</code>: Standard shell commands to fetch source code.</li>
          <li><code>patch_block</code>: Defines file modifications.
              <ul>
                  <li>Keys: <code>path</code> (relative file path), <code>action</code> (<code>append</code> or <code>replace</code>), <code>content</code> (text to write).</li>
                  <li>For <code>replace</code>, use the <code>find</code> key to specify the text to be replaced.</li>
              </ul>
          </li>
          <li><code>init_block</code>: Commands to setup the environment (e.g., <code>source openbmc-env</code>).</li>
          <li><code>build_block</code>: The main build command (e.g., <code>bitbake</code>).</li>
      </ul>
    </div>

    <div id="lang-zh" style="display: none;">
      <h1 class="mb-4">BuildServer ä½¿ç”¨æ‰‹å†Š</h1>

      <h3 class="mt-4">1. å¿«é€Ÿä¸Šæ‰‹ (Quick Start)</h3>
      <ol>
          <li><strong>ç™»å…¥</strong>ï¼šä½¿ç”¨æ‚¨çš„ç³»çµ±å¸³è™Ÿç™»å…¥ã€‚</li>
          <li><strong>è¨­å®š Profile</strong>ï¼šå‰å¾€ My Profileï¼Œå¡«å¯«æ‚¨çš„ GitLab Token èˆ‡ Emailã€‚</li>
          <li><strong>å»ºç«‹ Job</strong>ï¼šé»æ“Š "Create Job"ï¼Œé¸æ“‡ä¸€å€‹ Recipeï¼Œç„¶å¾ŒæŒ‰ä¸‹ Createã€‚</li>
          <li><strong>ç­‰å¾…é€šçŸ¥</strong>ï¼šå®Œæˆå¾Œæ‚¨æœƒæ”¶åˆ° Email é€šçŸ¥ã€‚</li>
      </ol>

      <h3 class="mt-4">2. åˆæ¬¡è¨­å®š (Initial Setup)</h3>
      <ul>
          <li><strong>Profile è¨­å®š</strong>ï¼šæ‚¨å¿…é ˆè¨­å®š <strong>GitLab Username &amp; Token</strong> (ç”¨æ–¼å­˜å–ç¨‹å¼ç¢¼) ä»¥åŠ <strong>Notification Email</strong> (æ¥æ”¶é€šçŸ¥)ã€‚è¨­å®šå®Œæˆå¾Œè«‹è¨˜å¾—é»æ“Š "Save Profile"ã€‚</li>
      </ul>

      <h3 class="mt-4">3. æ ¸å¿ƒæ¦‚å¿µ (Core Concepts)</h3>
      <ul>
          <li><strong>Recipes (é…æ–¹)</strong>ï¼šå®šç¾©å¦‚ä½•å»ºç½®å°ˆæ¡ˆçš„ YAML æ¨¡æ¿ (ä½æ–¼ <code>platform/project.yaml</code>)ã€‚</li>
          <li><strong>Jobs (ä»»å‹™)</strong>ï¼šRecipe çš„ä¸€æ¬¡åŸ·è¡Œå¯¦ä¾‹ã€‚æ¯å€‹ Job éƒ½æœ‰ç¨ç«‹çš„ ID èˆ‡ Workspaceã€‚</li>
      </ul>

      <h3 class="mt-4">4. ä»»å‹™ç®¡ç† (Job Management)</h3>
      <ul>
          <li><strong>ç‹€æ…‹</strong>ï¼š<span class="text-warning">ğŸŸ  Pending (æ’éšŠä¸­)</span>, <span class="text-primary">ğŸ”µ Running (åŸ·è¡Œä¸­)</span>, <span class="text-success">ğŸŸ¢ Success (æˆåŠŸ)</span>, <span class="text-danger">ğŸ”´ Failed (å¤±æ•—)</span>ã€‚</li>
          <li><strong>æ“ä½œ</strong>ï¼š
              <ul>
                  <li><strong>Pin (é‡˜é¸)</strong>ï¼šä¿è­· Job ä¸è¢«è‡ªå‹•æ¸…ç†ã€‚</li>
                  <li><strong>Retry (é‡è©¦)</strong>ï¼šåŸåœ°é‡æ–°åŸ·è¡Œå·²çµæŸçš„ Jobã€‚</li>
                  <li><strong>Prune (æ¸…ç†)</strong>ï¼šåˆªé™¤ Workspace æª”æ¡ˆä»¥é‡‹æ”¾ç©ºé–“ (ä¿ç•™ Log)ã€‚</li>
                  <li><strong>SSH Connect</strong>ï¼šé»æ“Š <strong>çµ‚ç«¯æ©Ÿåœ–ç¤º</strong> å¯è¤‡è£½ SSH æŒ‡ä»¤é€²è¡Œé™¤éŒ¯ã€‚</li>
              </ul>
          </li>
      </ul>

      <h3 class="mt-4">5. é€²éšé™¤éŒ¯ (SSH)</h3>
      <p>é»æ“Šåˆ—è¡¨ä¸­çš„ "Copy SSH" æŒ‰éˆ•å¯å–å¾—å¦‚ä¸‹æŒ‡ä»¤ï¼š</p>
      <blockquote><code>ssh -tt user@host "cd /work/jobs/123 &amp;&amp; exec bash -l"</code></blockquote>
      <p>é€™èƒ½è®“æ‚¨ç›´æ¥ç™»å…¥è©² Job çš„ Workspace ä¸¦è¼‰å…¥å¥½ç’°å¢ƒè®Šæ•¸ã€‚</p>

      <h3 class="mt-4">6. Recipe é…ç½®æŒ‡å— (Recipe Configuration Guide)</h3>
      <p>Recipe ä½¿ç”¨ YAML æ ¼å¼å®šç¾©ã€‚ç³»çµ±åŸ·è¡Œé †åºç‚ºï¼š<strong>Clone &rarr; Patch &rarr; Init &rarr; Build</strong>ã€‚</p>

      <div class="card bg-light border-0">
        <div class="card-header bg-transparent border-0 pb-0">
            <span class="badge bg-primary">å¯¦ä¾‹åƒè€ƒ: AST2600 EVB</span>
        </div>
        <div class="card-body p-3">
          <pre><code class="language-yaml">schema_version: 1
display_name: "AST2600 EVB Mainline"
# æ³¨æ„: 'workdir' æ˜¯é¸å¡«çš„ã€‚å¦‚æœçœç•¥ï¼Œæ‚¨å¿…é ˆåœ¨æŒ‡ä»¤ä¸­æ‰‹å‹• 'cd' é€²å…¥ç›®éŒ„ã€‚

# 1. Clone éšæ®µ
clone_block:
  lines:
    # Clone åŸºç¤ repo ä¸¦é€²å…¥ç›®éŒ„ä»¥ clone å­å±¤
    - git clone https://git.ami.com/core/ami-bmc/base-tech/openbmc onetree; cd onetree
    - git clone https://git.ami.com/core/ami-bmc/one-tree/core/meta-core
    - git clone https://git.ami.com/core/ami-bmc/one-tree/core/meta-ami
    # åŠ å…¥ EVB ç‰¹å®šå±¤
    - git clone https://git.ami.com/core/ami-bmc/one-tree/amd/crb/venice meta-amd/meta-venice

# 2. Patch éšæ®µ (é¸å¡«)
# åœ¨ Init éšæ®µå‰ä¿®æ”¹æª”æ¡ˆ
patch_block:
  # ç¯„ä¾‹: åœ¨ local.conf å¾Œé¢é™„åŠ å…§å®¹
  - path: "conf/local.conf"
    action: append
    content: 'IMAGE_INSTALL:append = " my-package"'
  # ç¯„ä¾‹: å–ä»£ layer config ä¸­çš„æ–‡å­—
  - path: "meta-ami/conf/layer.conf"
    action: replace
    find: 'CORE_IMAGE_EXTRA_INSTALL ?= ""'
    content: 'CORE_IMAGE_EXTRA_INSTALL ?= "ami-base"'

# 3. Init éšæ®µ
init_block:
  lines:
    # å› ç‚ºæ²’æœ‰è¨­å®š workdir keyï¼Œæˆ‘å€‘å¿…é ˆæ‰‹å‹•é€²å…¥ç›®éŒ„
    - cd onetree
    - meta-ami/github-gitlab-url.sh
    - TEMPLATECONF=meta-ami/meta-evb/meta-evb-aspeed/meta-evb-ast2600/conf/templates/default . openbmc-env

# 4. Build éšæ®µ
build_block:
  lines:
    - bitbake obmc-phosphor-image</code></pre>
        </div>
      </div>

      <h5 class="mt-3">å€å¡Šå®šç¾©</h5>
      <ul>
          <li><code>clone_block</code>: ä¸‹è¼‰ç¨‹å¼ç¢¼çš„æ¨™æº– Shell æŒ‡ä»¤ã€‚</li>
          <li><code>patch_block</code>: å®šç¾©æª”æ¡ˆä¿®æ”¹ã€‚
              <ul>
                  <li>é—œéµå­—: <code>path</code> (ç›¸å°è·¯å¾‘), <code>action</code> (<code>append</code> æˆ– <code>replace</code>), <code>content</code> (å¯«å…¥å…§å®¹)ã€‚</li>
                  <li>è‹¥æ˜¯ <code>replace</code>ï¼Œéœ€ä½¿ç”¨ <code>find</code> æŒ‡å®šè¦è¢«å–ä»£çš„æ–‡å­—ã€‚</li>
              </ul>
          </li>
          <li><code>init_block</code>: åˆå§‹åŒ–å»ºç½®ç’°å¢ƒ (ä¾‹å¦‚ <code>source openbmc-env</code>)ã€‚</li>
          <li><code>build_block</code>: ä¸»è¦å»ºç½®æŒ‡ä»¤ (ä¾‹å¦‚ <code>bitbake</code>)ã€‚</li>
      </ul>
    </div>
  </div>
</div>

<script>
  (() => {
    const buttons = document.querySelectorAll("[data-lang]");
    const en = document.getElementById("lang-en");
    const zh = document.getElementById("lang-zh");
    function setLang(lang) {
      if (!en || !zh) return;
      if (lang === "zh") {
        en.style.display = "none";
        zh.style.display = "";
      } else {
        en.style.display = "";
        zh.style.display = "none";
      }
      buttons.forEach((btn) => {
        const isActive = btn.getAttribute("data-lang") === lang;
        btn.classList.toggle("active", isActive);
      });
    }
    buttons.forEach((btn) => {
      btn.addEventListener("click", () => setLang(btn.getAttribute("data-lang") || "en"));
    });
    setLang("en");
  })();
</script>
{% endblock %}
