{% extends "_layout.html" %}
{% block title %}Help{% endblock %}
{% block content %}
<div class="card shadow-sm">
  <div class="card-body">
    <h2 class="mb-4">BuildServer User Manual</h2>

    <h3 class="mt-3">1. Quick Start</h3>
    <ol>
      <li><strong>Login</strong>: Sign in with your system credentials.</li>
      <li><strong>Setup Profile</strong>: Go to Profile, enter your GitLab Token and Email.</li>
      <li><strong>Create Job</strong>: Click <em>New Job</em>, select a Recipe, and hit Create.</li>
      <li><strong>Wait</strong>: You will receive an email notification when done.</li>
    </ol>

    <h3 class="mt-4">2. Initial Setup</h3>
    <ul>
      <li><strong>Profile</strong>: You must set your <strong>GitLab Username &amp; Token</strong> (for accessing code) and <strong>Notification Email</strong> (for alerts). Don‚Äôt forget to click ‚ÄúSave Profile‚Äù.</li>
    </ul>

    <h3 class="mt-4">3. Core Concepts</h3>
    <ul>
      <li><strong>Recipes</strong>: YAML templates (in <code>platform/project.yaml</code>) defining how to build a project.</li>
      <li><strong>Jobs</strong>: A specific execution of a recipe. Each job has a unique ID and workspace.</li>
    </ul>

    <h3 class="mt-4">4. Job Management</h3>
    <ul>
      <li><strong>Status</strong>: üü† Pending, üîµ Running, üü¢ Success, üî¥ Failed.</li>
      <li><strong>Actions</strong>:
        <ul>
          <li><strong>Pin</strong>: Protect a job from auto-cleanup.</li>
          <li><strong>Retry</strong>: Rerun a finished job in-place.</li>
          <li><strong>Prune</strong>: Remove workspace files to save disk space (logs are kept).</li>
          <li><strong>SSH Connect</strong>: Click the <strong>Terminal Icon</strong> to copy the SSH command for direct debugging.</li>
        </ul>
      </li>
    </ul>

    <h3 class="mt-4">5. Advanced Debugging (SSH)</h3>
    <p>Click ‚ÄúCopy SSH‚Äù to get a command like:</p>
    <blockquote><code>ssh -tt user@host "cd /work/jobs/123 &amp;&amp; exec bash -l"</code></blockquote>
    <p>This logs you directly into the job‚Äôs workspace with the environment loaded.</p>

    <h3 class="mt-4">6. Recipe Configuration Guide</h3>
    <p>Recipes are defined in YAML format. The system executes blocks in this order: <strong>Clone &rarr; Patch &rarr; Init &rarr; Build</strong>.</p>

    <div class="card bg-light border-0">
      <div class="card-header bg-transparent border-0 pb-0">
          <span class="badge bg-primary">Real-World Example: AST2600 EVB</span>
      </div>
      <div class="card-body p-3">
<pre><code class="language-yaml">schema_version: 1
display_name: "AST2600 EVB Mainline"
# Note: 'workdir' is optional. If omitted, you must 'cd' into directories manually.

# 1. Clone Stage
clone_block:
  lines:
    # Clone base repo and enter it to clone sub-layers inside
    - git clone https://git.ami.com/core/ami-bmc/base-tech/openbmc onetree; cd onetree
    - git clone https://git.ami.com/core/ami-bmc/one-tree/core/meta-core
    - git clone https://git.ami.com/core/ami-bmc/one-tree/core/meta-ami
    # Add EVB specific layer
    - git clone https://git.ami.com/core/ami-bmc/one-tree/amd/crb/venice meta-amd/meta-venice

# 2. Patch Stage (Optional)
# Modifies files BEFORE the Init stage.
patch_block:
  # Example: Append a package to local.conf
  - path: "conf/local.conf"
    action: append
    content: 'IMAGE_INSTALL:append = " my-package"'
  # Example: Replace text in a layer config
  - path: "meta-ami/conf/layer.conf"
    action: replace
    find: 'CORE_IMAGE_EXTRA_INSTALL ?= ""'
    content: 'CORE_IMAGE_EXTRA_INSTALL ?= "ami-base"'

# 3. Init Stage
init_block:
  lines:
    # We must enter the directory because 'workdir' key was not set
    - cd onetree
    - meta-ami/github-gitlab-url.sh
    - TEMPLATECONF=meta-ami/meta-evb/meta-evb-aspeed/meta-evb-ast2600/conf/templates/default . openbmc-env

# 4. Build Stage
build_block:
  lines:
    - bitbake obmc-phosphor-image</code></pre>
      </div>
    </div>

    <h5 class="mt-3">Block Definition</h5>
    <ul>
        <li><code>clone_block</code>: Standard shell commands to fetch source code.</li>
        <li><code>patch_block</code>: Defines file modifications.
            <ul>
                <li>Keys: <code>path</code> (relative file path), <code>action</code> (<code>append</code> or <code>replace</code>), <code>content</code> (text to write).</li>
                <li>For <code>replace</code>, use the <code>find</code> key to specify the text to be replaced.</li>
            </ul>
        </li>
        <li><code>init_block</code>: Commands to setup the environment (e.g., <code>source openbmc-env</code>).</li>
        <li><code>build_block</code>: The main build command (e.g., <code>bitbake</code>).</li>
    </ul>
  </div>
</div>
{% endblock %}
