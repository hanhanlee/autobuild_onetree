{% extends "_layout.html" %}
{% block title %}Create Job{% endblock %}
{% block content %}
<h1>Create Job</h1>
{% if error %}<p class="error">{{ error }}</p>{% endif %}
<p><a href="/recipes/new" style="margin-right:1rem;">New Template</a> | <a href="/settings">GitLab token</a></p>
<div class="card">
    <form method="post" action="/new" style="display:grid;grid-template-columns:1fr;gap:0.85rem;max-width:720px;">
        <div style="display:flex;flex-direction:column;gap:0.35rem;">
            <label for="recipe-select" style="font-weight:600;">Recipe Template</label>
            {% if recipes_count is defined %}
            <div class="status" style="color:#666;font-size:0.9rem;">presets_root: {{ presets_root }}, recipes_count: {{ recipes_count }}</div>
            {% endif %}
            <select id="recipe-select" name="recipe_id" required>
                <option value="" disabled {% if not recipe_id %}selected{% endif %}>Select a recipe...</option>
                {% for r in recipes or [] %}
                    <option value="{{ r.id }}" {% if recipe_id==r.id %}selected{% endif %}>{{ r.id }} — {{ r.display_name }}</option>
                {% endfor %}
            </select>
            {% if (recipes or [])|length == 0 %}
            <div class="status" style="color:#a15c00;font-size:0.95rem;">No recipes found. Create one via /recipes/new and ensure it is saved under presets_root/&lt;platform&gt;/&lt;project&gt;.yaml</div>
            {% endif %}
            <input id="recipe-filter" value="" placeholder="Filter recipes (e.g. 2600)" autocomplete="off">
            <div style="color:#555;font-size:0.9rem;">Type part of a platform or project name to filter the dropdown; selection comes from the dropdown.</div>
        </div>
        <label>Note (optional)
            <textarea name="note" rows="3" placeholder="Optional note for this job">{{ note or '' }}</textarea>
        </label>
        <button type="submit">Submit</button>
    </form>
</div>
<script type="application/json" id="recipe-data">{{ recipes or [] | tojson }}</script>
<script>
(() => {
    const filterInput = document.getElementById("recipe-filter");
    const select = document.getElementById("recipe-select");
    const dataEl = document.getElementById("recipe-data");
    if (!filterInput || !dataEl || !select) return;
    let recipes = [];
    try {
        recipes = JSON.parse(dataEl.textContent || "[]");
    } catch (e) {
        recipes = [];
    }
    const fuzzyMatch = (query, text) => {
        const q = (query || "").toLowerCase().replace(/\s+/g, "");
        const t = (text || "").toLowerCase().replace(/\s+/g, "");
        if (!q) return true;
        return t.includes(q);
    };
    const renderOptions = (query) => {
        const q = (query || "").trim();
        const current = select.value;
        select.innerHTML = "";
        const defaultOpt = document.createElement("option");
        defaultOpt.value = "";
        defaultOpt.disabled = true;
        defaultOpt.textContent = "Select a recipe...";
        defaultOpt.selected = !current;
        select.appendChild(defaultOpt);
        const matched = recipes.filter((r) => fuzzyMatch(q, `${r.id} ${r.display_name || ""}`));
        matched.forEach((r) => {
            const opt = document.createElement("option");
            opt.value = r.id;
            opt.textContent = `${r.id} — ${r.display_name}`;
            if (current === r.id) {
                opt.selected = true;
                defaultOpt.selected = false;
            }
            select.appendChild(opt);
        });
        const hasCurrent = matched.some((r) => r.id === current);
        if (!hasCurrent) {
            select.value = "";
            defaultOpt.selected = true;
        }
    };
    filterInput.addEventListener("input", () => renderOptions(filterInput.value));
    renderOptions(filterInput.value);
})();
</script>
{% endblock %}
