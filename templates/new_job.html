{% extends "_layout.html" %}
{% block title %}Create Job{% endblock %}
{% block content %}
<div class="bg-light py-2 px-1 rounded">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="mb-0 text-dark">Create Job</h2>
      <small class="text-muted">Configure source, target, and recipe for a new build.</small>
    </div>
  </div>

  {% if error %}<div class="alert alert-danger">{{ error }}</div>{% endif %}
  {% if missing_creds %}
  <div class="alert alert-danger d-flex align-items-center" role="alert">
    <i class="bi bi-exclamation-octagon-fill me-2"></i>
    <div>GitLab username and token are required. Please save them in Settings before creating a job.</div>
  </div>
  {% endif %}

  <form method="post" action="/new" class="row g-3">
    <div class="col-md-3">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="text-muted text-uppercase small mb-3">Steps</h6>
          <div class="d-flex flex-column gap-3">
            <div class="d-flex align-items-start">
              <span class="badge bg-primary rounded-circle me-2">1</span>
              <div>
                <div class="fw-semibold text-dark">Source &amp; Target</div>
                <small class="text-muted">Select recipe, pipeline stages</small>
              </div>
            </div>
            <div class="d-flex align-items-start">
              <span class="badge bg-secondary rounded-circle me-2">2</span>
              <div>
                <div class="fw-semibold text-dark">Recipe &amp; Metadata</div>
                <small class="text-muted">Patches and notes</small>
              </div>
            </div>
            <div class="d-flex align-items-start">
              <span class="badge bg-secondary rounded-circle me-2">3</span>
              <div>
                <div class="fw-semibold text-dark">Confirm &amp; Submit</div>
                <small class="text-muted">Review and create job</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-9">
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title border-bottom pb-2 mb-4 text-dark">Source &amp; Target</h5>

          <div class="row g-3">
            <div class="col-lg-6">
              <label class="form-label fw-semibold" for="recipe-select">Recipe Template</label>
              {% if recipes_count is defined %}
              <div class="text-muted small mb-1">presets_root: {{ presets_root }}, recipes_count: {{ recipes_count }}</div>
              {% endif %}
              <select id="recipe-select" name="recipe_id" class="form-select" required>
                <option value="" disabled {% if not recipe_id %}selected{% endif %}>Select a recipe...</option>
                {% for r in recipes or [] %}
                  <option value="{{ r.id }}" {% if recipe_id==r.id %}selected{% endif %}>{{ r.id }}{% if r.description %} ({{ r.description }}){% endif %}</option>
                {% endfor %}
              </select>
              <input id="recipe-filter" class="form-control mt-2" value="" placeholder="Filter recipes (e.g. 2600)" autocomplete="off">
              <div class="text-muted small mt-1">Type to filter the dropdown; selection comes from the list.</div>
              {% if (recipes or [])|length == 0 %}
              <div class="text-warning small mt-1">No recipes found. Create one via /projects and ensure it is saved under presets_root/&lt;platform&gt;/&lt;project&gt;.yaml</div>
              {% endif %}
            </div>
            <div class="col-lg-6">
              <label class="form-label fw-semibold d-block">Pipeline Stages</label>
              <div class="btn-group w-100" role="group">
                <input type="checkbox" class="btn-check" id="check-clone" name="do_clone" autocomplete="off" checked onchange="toggleSection('section-clone', this.checked)">
                <label class="btn btn-outline-primary" for="check-clone">1. Clone</label>

                <input type="checkbox" class="btn-check" id="check-edit" name="do_edit" autocomplete="off" onchange="toggleSection('section-edit', this.checked)">
                <label class="btn btn-outline-primary" for="check-edit">2. Edit/Patch</label>

                <input type="checkbox" class="btn-check" id="check-init" name="do_init" autocomplete="off" checked onchange="toggleSection('section-init', this.checked)">
                <label class="btn btn-outline-primary" for="check-init">3. Init</label>

                <input type="checkbox" class="btn-check" id="check-build" name="do_build" autocomplete="off" checked onchange="toggleSection('section-build', this.checked)">
                <label class="btn btn-outline-primary" for="check-build">4. Build</label>
              </div>
              <div class="mt-3">
                <label class="form-label fw-semibold" for="base_job_id">Base Job ID (Reuse Artifacts)</label>
                <div class="input-group">
                  <input type="number" class="form-control" id="base_job_id" name="base_job_id" placeholder="Job ID (e.g. 57)" value="{{ base_job_id or '' }}">
                  <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#baseJobModal">Browse Jobs</button>
                </div>
                <div class="text-muted small mt-1">Reuse Artifacts: Clones the workspace from an existing job ID (cp -a). Useful for A/B testing or basing off a Golden Image.</div>
              </div>
            </div>
          </div>

          <div class="alert alert-info small mt-3 d-flex align-items-start gap-2">
            <i class="bi bi-folder2-open mt-1"></i>
            <div>
              <div class="fw-semibold">Execution context: <code id="workdir-hint">workspace root</code></div>
              <div id="workdir-hint-desc" class="text-muted">Init and Build run at the workspace root unless the recipe defines a Workdir.</div>
            </div>
          </div>

          <div class="mt-4">
            <div class="row g-3">
              <div class="col-md-6" id="section-clone">
                <label class="form-label fw-semibold">Clone Commands</label>
                <textarea class="form-control font-monospace" name="clone_script" rows="4" placeholder="git clone ..." readonly></textarea>
              </div>
              <div class="col-md-6" id="section-init">
                <label class="form-label fw-semibold">Initialization Commands</label>
                <textarea class="form-control font-monospace" name="init_script" rows="4" placeholder="source oe-init-build-env" readonly></textarea>
              </div>
              <div class="col-12" id="section-build">
                <label class="form-label fw-semibold">Build Commands</label>
                <textarea class="form-control font-monospace" name="build_script" rows="3" placeholder="bitbake ..." required readonly></textarea>
              </div>
            </div>
            <div class="text-muted small mt-2">When a recipe defines a Workdir, Init and Build commands start inside it automatically.</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <h5 class="card-title border-bottom pb-2 mb-4 text-dark">Recipe &amp; Metadata</h5>

          <div id="section-edit" class="card p-3 mb-1 border-warning">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <span class="fw-semibold text-dark">File Patches</span>
              <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addPatchRow()"><i class="bi bi-plus-lg"></i> Add Patch</button>
            </div>
            <div id="patch-container" class="mb-3"></div>
            <div class="text-muted small mb-1">Apply automated file patches (append/replace) after cloning.</div>
          </div>

          <div class="mb-0">
            <label class="form-label fw-semibold" for="note">Note (optional)</label>
            <textarea class="form-control" id="note" name="note" rows="3" placeholder="Optional note for this job">{{ note or '' }}</textarea>
          </div>
          <div class="mb-0 mt-3">
            <label class="form-label fw-semibold" for="cc_emails">CC Notification To (comma separated)</label>
            <input type="text" class="form-control" id="cc_emails" name="cc_emails" value="{{ cc_emails or '' }}">
            <div class="text-muted small">Emails to notify on job completion, comma separated.</div>
          </div>
        </div>
      </div>

      <div class="mt-3 position-sticky" style="bottom: 0; z-index: 2;">
        <div class="card">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div class="text-muted">Review selections and start the job.</div>
            <button type="submit" class="btn btn-primary btn-lg">
              <i class="bi bi-play-fill me-1"></i> Create Job
            </button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<script>
// 1. Data Injection (Backend -> Frontend)
const recipesData = {};
{% for r in recipes or [] %}
{
    const rId = String({{ (r.id)|tojson }});
    {% set clone_val = r.repo_url %}
    {% if r.clone_block and r.clone_block.lines %}
        {% set clone_val = r.clone_block.lines | join('\\n') %}
    {% endif %}

    {% set init_val = r.init_script or 'oe-init-build-env' %}
    {% if r.init_block and r.init_block.lines %}
        {% set init_val = r.init_block.lines | join('\\n') %}
    {% endif %}

    {% set build_val = r.build_cmd %}
    {% if r.build_block and r.build_block.lines %}
        {% set build_val = r.build_block.lines | join('\\n') %}
    {% endif %}

    recipesData[rId] = {
        clone_script: {{ (clone_val or '')|tojson }},
        init_script:  {{ (init_val  or '')|tojson }},
        build_script: {{ (build_val or '')|tojson }},
        workdir: {{ (r.workdir or '')|tojson }},
    };
}
{% endfor %}

// 2. Visibility Logic
function toggleSection(id, show) {
    const el = document.getElementById(id);
    if (el) {
        if (show) el.classList.remove("d-none");
        else el.classList.add("d-none");
    }
}

function updateWorkdirHint(data) {
    const hintEl = document.getElementById("workdir-hint");
    const descEl = document.getElementById("workdir-hint-desc");
    if (!hintEl || !descEl) return;
    const wd = (data && data.workdir && String(data.workdir).trim()) || "";
    if (wd) {
        hintEl.textContent = wd;
        descEl.textContent = "Init and Build commands run inside this directory automatically.";
    } else {
        hintEl.textContent = "workspace root";
        descEl.textContent = "Init and Build run at the workspace root unless Workdir is set in the recipe.";
    }
}

// 3. Data Population Logic
function updateRecipeInfo() {
    const select = document.getElementById("recipe-select");
    if (!select) return;

    const rId = String(select.value);
    const data = recipesData[rId];

    const fields = [
        { name: "clone_script", key: "clone_script" },
        { name: "init_script",  key: "init_script" },
        { name: "build_script", key: "build_script" },
    ];

    if (data) {
        fields.forEach((f) => {
            const input = document.querySelector(`textarea[name=\"${f.name}\"]`);
            if (input) {
                input.value = data[f.key] || "";
                input.readOnly = true;
                input.classList.add("bg-light", "text-muted");
            }
        });
    } else {
        fields.forEach((f) => {
            const input = document.querySelector(`textarea[name=\"${f.name}\"]`);
            if (input) {
                input.value = "";
                input.readOnly = false;
                input.classList.remove("bg-light", "text-muted");
            }
        });
    }

    updateWorkdirHint(data);
}

// 4. Initialization
document.addEventListener("DOMContentLoaded", function () {
    const select = document.getElementById("recipe-select");
    if (select) select.addEventListener("change", updateRecipeInfo);

    const filterInput = document.getElementById("recipe-filter");
    if (filterInput && select) {
        const fuzzyMatch = (query, text) => {
            const q = (query || "").toLowerCase().replace(/\\s+/g, "");
            const t = (text || "").toLowerCase().replace(/\\s+/g, "");
            return !q || t.includes(q);
        };
        filterInput.addEventListener("input", () => {
            const q = filterInput.value.trim();
            Array.from(select.options).forEach((opt) => {
                if (!opt.value) return;
                const match = fuzzyMatch(q, opt.textContent);
                opt.hidden = !match;
                opt.disabled = !match;
            });
            if (select.selectedOptions.length && select.selectedOptions[0].hidden) {
                select.value = "";
            }
        });
    }

    const stageMap = {
        "check-clone": "section-clone",
        "check-edit": "section-edit",
        "check-init": "section-init",
        "check-build": "section-build",
    };
    Object.keys(stageMap).forEach((chkId) => {
        const checkbox = document.getElementById(chkId);
        const sectionId = stageMap[chkId];
        if (checkbox && sectionId) {
            checkbox.addEventListener("change", function () {
                toggleSection(sectionId, this.checked);
            });
            toggleSection(sectionId, checkbox.checked);
        }
    });

    document.querySelectorAll(".select-base-job").forEach((btn) => {
        btn.addEventListener("click", () => {
            const jobId = btn.getAttribute("data-job-id");
            const input = document.getElementById("base_job_id");
            if (input && jobId) {
                input.value = jobId;
            }
            const modalEl = document.getElementById("baseJobModal");
            if (modalEl) {
                const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                modal.hide();
            }
        });
    });

    updateRecipeInfo();
});

// Helper functions (Edit/Patch section)
function addPatchRow() {
    const tpl = document.getElementById("tpl-patch-row");
    if (tpl) document.getElementById("patch-container").appendChild(tpl.content.cloneNode(true));
}
function toggleFind(select) {
    const row = select.closest(".patch-row");
    const findInput = row.querySelector(".find-input");
    if (findInput) findInput.classList.toggle("d-none", select.value !== "replace");
}
</script>

<div class="modal fade" id="baseJobModal" tabindex="-1" aria-labelledby="baseJobModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="baseJobModalLabel">Select Base Job</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Status</th>
                <th>Recipe</th>
                <th>Created At</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for j in recent_jobs or [] %}
              <tr>
                <td>#{{ j.id }}</td>
                <td>{{ j.status }}</td>
                <td>{{ j.recipe_id or '-' }}</td>
                <td>{{ j.created_at or '-' }}</td>
                <td><button type="button" class="btn btn-sm btn-primary select-base-job" data-job-id="{{ j.id }}">Select</button></td>
              </tr>
              {% else %}
              <tr><td colspan="5" class="text-center text-muted py-3">No recent jobs available.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<template id="tpl-patch-row">
    <div class="row g-2 mb-2 patch-row align-items-center">
        <div class="col-4">
            <input type="text" name="patch_paths" class="form-control form-control-sm font-monospace" placeholder="Path (e.g. conf/local.conf)" required>
        </div>
        <div class="col-2">
            <select name="patch_actions" class="form-select form-select-sm" onchange="toggleFind(this)">
                <option value="append">Append</option>
                <option value="replace">Replace</option>
            </select>
        </div>
        <div class="col-5">
            <input type="text" name="patch_finds" class="form-control form-control-sm mb-1 d-none find-input" placeholder="Find text...">
            <textarea name="patch_contents" class="form-control form-control-sm font-monospace" rows="1" placeholder="Content..."></textarea>
        </div>
        <div class="col-1 text-end">
            <button type="button" class="btn btn-close" onclick="this.closest('.patch-row').remove()"></button>
        </div>
    </div>
</template>
{% endblock %}
