{% extends "_layout.html" %}
{% block title %}Create Job{% endblock %}
{% block content %}
<h1>Create Job</h1>
{% if error %}<p class="error">{{ error }}</p>{% endif %}
<p><a href="/projects" style="margin-right:1rem;">Create Recipe (Project Template v1)</a> | <a href="/settings">GitLab token</a></p>
<div class="card">
    <form method="post" action="/new" style="display:grid;grid-template-columns:1fr;gap:0.85rem;max-width:840px;">
        <div style="display:flex;flex-direction:column;gap:0.35rem;">
            <label for="recipe-select" style="font-weight:600;">Recipe Template</label>
            {% if recipes_count is defined %}
            <div class="status" style="color:#666;font-size:0.9rem;">presets_root: {{ presets_root }}, recipes_count: {{ recipes_count }}</div>
            {% endif %}
            <select id="recipe-select" name="recipe_id" required>
                <option value="" disabled {% if not recipe_id %}selected{% endif %}>Select a recipe...</option>
                {% for r in recipes or [] %}
                    <option value="{{ r.id }}" {% if recipe_id==r.id %}selected{% endif %}>{{ r.id }}{% if r.description %} ({{ r.description }}){% endif %}</option>
                {% endfor %}
            </select>
            {% if (recipes or [])|length == 0 %}
            <div class="status" style="color:#a15c00;font-size:0.95rem;">No recipes found. Create one via /projects (Project Template v1) and ensure it is saved under presets_root/&lt;platform&gt;/&lt;project&gt;.yaml</div>
            {% endif %}
            <input id="recipe-filter" value="" placeholder="Filter recipes (e.g. 2600)" autocomplete="off">
            <div style="color:#555;font-size:0.9rem;">Type part of a platform or project name to filter the dropdown; selection comes from the dropdown.</div>
        </div>

        <div class="card" style="padding:0.85rem;border:1px solid #d0d7de;background:#f8fafc;">
            <label class="form-label fw-bold d-block">Pipeline Stages</label>
            <div class="btn-group w-100" role="group">
                <input type="checkbox" class="btn-check" id="check-clone" name="do_clone" autocomplete="off" checked onchange="toggleSection('section-clone', this.checked)">
                <label class="btn btn-outline-primary" for="check-clone">1. Clone</label>

                <input type="checkbox" class="btn-check" id="check-edit" name="do_edit" autocomplete="off" onchange="toggleSection('section-edit', this.checked)">
                <label class="btn btn-outline-warning" for="check-edit">2. Edit/Patch</label>

                <input type="checkbox" class="btn-check" id="check-init" name="do_init" autocomplete="off" checked>
                <label class="btn btn-outline-info" for="check-init">3. Init</label>

                <input type="checkbox" class="btn-check" id="check-build" name="do_build" autocomplete="off" checked onchange="toggleSection('section-build', this.checked)">
                <label class="btn btn-outline-success" for="check-build">4. Build</label>
            </div>
        </div>

        <div id="section-clone" class="card p-3 mb-1 bg-light border-primary">
            <label class="form-label text-primary fw-bold">Git Configuration</label>
            <input type="text" class="form-control mb-2" name="repo_url" placeholder="Git Repository URL">
            <input type="text" class="form-control" name="branch" placeholder="Branch (default: main)">
        </div>

        <div id="section-edit" class="d-none card p-3 mb-1 border-warning">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <label class="form-label text-warning fw-bold mb-0">File Patches</label>
                <button type="button" class="btn btn-sm btn-outline-warning" onclick="addPatchRow()">
                    <i class="bi bi-plus-lg"></i> Add Patch
                </button>
            </div>
            <div id="patch-container"></div>
            <div class="form-text text-muted">Apply automated file patches (append/replace) after cloning.</div>
        </div>

        <div id="section-build" class="card p-3 mb-1 bg-light border-success">
            <label class="form-label text-success fw-bold">Build Configuration</label>
            <input type="text" class="form-control font-monospace" name="build_cmd" placeholder="bitbake core-image-minimal" required>
        </div>

        <div style="display:flex;flex-direction:column;gap:0.35rem;">
            <label for="codebase-select" style="font-weight:600;">Codebase (optional unless build/edit only)</label>
            {% if codebases_count is defined %}
            <div class="status" style="color:#666;font-size:0.9rem;">workspaces_root: {{ workspaces_root }}, codebases_count: {{ codebases_count }}</div>
            {% endif %}
            <select id="codebase-select" name="codebase_id">
                <option value="" {% if not codebase_id %}selected{% endif %}>-- Select a codebase --</option>
                {% for cb in codebases or [] %}
                    <option value="{{ cb.id }}" {% if codebase_id==cb.id %}selected{% endif %}>{{ cb.label or cb.id }}</option>
                {% endfor %}
            </select>
            <div style="color:#555;font-size:0.9rem;">Build/Edit stages that require existing sources should set a codebase with codebase.json under workspaces_root.</div>
        </div>
        <label>Note (optional)
            <textarea name="note" rows="3" placeholder="Optional note for this job">{{ note or '' }}</textarea>
        </label>
        <button type="submit">Submit</button>
    </form>
</div>
<script>
// 1. Data Injection
const recipesData = {};
{% for r in recipes or [] %}
    // Force ID to string to ensure matching with Select Value
    recipesData["{{ r.id }}"] = {
        repo_url: {{ (r.repo_url or '')|tojson }},
        branch: {{ (r.branch or '')|tojson }},
        build_cmd: {{ (r.build_cmd or '')|tojson }}
    };
{% endfor %}

console.log("Loaded Recipes Data:", recipesData); // Debug Log

// 2. Section Visibility Logic
function toggleSection(id, show) {
    const el = document.getElementById(id);
    if (!el) return;
    if (show) el.classList.remove("d-none");
    else el.classList.add("d-none");
}

// 3. Dynamic Patch Rows
function addPatchRow() {
    const tpl = document.getElementById("tpl-patch-row");
    if (!tpl) return;
    const clone = tpl.content.cloneNode(true);
    document.getElementById("patch-container").appendChild(clone);
}

function toggleFind(select) {
    const row = select.closest(".patch-row");
    const findInput = row.querySelector(".find-input");
    if (select.value === "replace") findInput.classList.remove("d-none");
    else findInput.classList.add("d-none");
}

// 4. Update Inputs from Recipe
function updateRecipeInfo() {
    const select = document.getElementById("recipe-select");
    if (!select) return;
    
    const rId = String(select.value); // Convert to String
    const data = recipesData[rId];
    
    console.log("Selecting Recipe:", rId, data); // Debug Log

    const repoInput = document.querySelector('input[name="repo_url"]');
    const branchInput = document.querySelector('input[name="branch"]');
    const cmdInput = document.querySelector('input[name="build_cmd"]');

    if (!repoInput || !branchInput || !cmdInput) return;

    if (data) {
        // Populate and Lock
        repoInput.value = data.repo_url || "";
        branchInput.value = data.branch || "";
        cmdInput.value = data.build_cmd || "";
        
        [repoInput, branchInput, cmdInput].forEach(el => {
            el.readOnly = true;
            el.classList.add("bg-light", "text-muted");
        });
    } else {
        // Clear and Unlock
        [repoInput, branchInput, cmdInput].forEach(el => {
            el.readOnly = false;
            el.classList.remove("bg-light", "text-muted");
            el.value = "";
        });
    }
}

// 5. Initialization
document.addEventListener("DOMContentLoaded", function() {
    // Attach Listeners
    const select = document.getElementById("recipe-select");
    if (select) select.addEventListener("change", updateRecipeInfo);

    // Filter Logic (Search)
    const filterInput = document.getElementById("recipe-filter");
    if (filterInput && select) {
        const fuzzyMatch = (query, text) => {
            const q = (query || "").toLowerCase().replace(/\s+/g, "");
            const t = (text || "").toLowerCase().replace(/\s+/g, "");
            return !q || t.includes(q);
        };
        filterInput.addEventListener("input", () => {
            const q = filterInput.value.trim();
            Array.from(select.options).forEach((opt) => {
                if (!opt.value) return;
                const match = fuzzyMatch(q, opt.textContent);
                opt.hidden = !match;
                opt.disabled = !match;
            });
            if (select.selectedOptions.length && select.selectedOptions[0].hidden) {
                select.value = "";
            }
        });
    }

    // Initialize Visibility
    const map = {
        "check-clone": "section-clone",
        "check-edit": "section-edit",
        "check-build": "section-build",
    };
    ["check-clone", "check-edit", "check-init", "check-build"].forEach((id) => {
        const el = document.getElementById(id);
        if (el && map[id]) {
            toggleSection(map[id], el.checked);
        }
    });

    // Trigger Update
    updateRecipeInfo();
});
</script>

<template id="tpl-patch-row">
    <div class="row g-2 mb-2 patch-row align-items-center">
        <div class="col-4">
            <input type="text" name="patch_paths" class="form-control form-control-sm font-monospace" placeholder="Path (e.g. conf/local.conf)" required>
        </div>
        <div class="col-2">
            <select name="patch_actions" class="form-select form-select-sm" onchange="toggleFind(this)">
                <option value="append">Append</option>
                <option value="replace">Replace</option>
            </select>
        </div>
        <div class="col-5">
            <input type="text" name="patch_finds" class="form-control form-control-sm mb-1 d-none find-input" placeholder="Find text...">
            <textarea name="patch_contents" class="form-control form-control-sm font-monospace" rows="1" placeholder="Content..."></textarea>
        </div>
        <div class="col-1 text-end">
            <button type="button" class="btn btn-close" onclick="this.closest('.patch-row').remove()"></button>
        </div>
    </div>
</template>
{% endblock %}
